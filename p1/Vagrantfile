Vagrant.configure("2") do |config|

  # SERVER CONFIGURATION
  config.vm.define "hbelleS" do |server|
    server.vm.box = "debian/buster64"
    server.vm.network "private_network", ip: "192.168.56.110", interface: "eth1"
    server.vm.network "forwarded_port", guest: 22, host: 4242, id: "ssh"
    server.vm.provider "virtualbox" do |vb|
      vb.name = "hbelleS"
      vb.memory = "1024"
      vb.cpus = 1
    end
    server.vm.synced_folder "./conf", "/vagrant", type: "nfs", nfs_version: 4
    server.vm.provision "shell", inline: <<-SHELL
      set -x
      sudo apt-get update
      sudo apt-get install -y curl
      # Installer K3s en tant que serveur maître avec un nom de nœud spécifique
      curl -sSL https://get.k3s.io | sh -s - server --node-ip 192.168.56.110 --node-name hbelleS
      # Copier le fichier kubeconfig pour l'accès externe
      sudo cp /etc/rancher/k3s/k3s.yaml /vagrant/kubeconfig
      # Modifier l'adresse IP dans le fichier kubeconfig
      sed -i "s/127\\.0\\.0\\.1/192.168.56.110/" /vagrant/kubeconfig
      # Extraire le token pour les agents
      sudo cat /var/lib/rancher/k3s/server/node-token > /vagrant/node-token
    SHELL
  end

  # SERVER WORKER CONFIGURATION
  config.vm.define "hbelleSW" do |serverWorker|
    serverWorker.vm.box = "debian/buster64"
    serverWorker.vm.network "private_network", ip: "192.168.56.111", interface: "eth1"
    serverWorker.vm.network "forwarded_port", guest: 22, host: 4243, id: "ssh"
    serverWorker.vm.provider "virtualbox" do |vb|
      vb.name = "hbelleSW"
      vb.memory = "1024"
      vb.cpus = 1
    end
    serverWorker.vm.synced_folder "./conf", "/vagrant", type: "nfs", nfs_version: 4
    serverWorker.vm.provision "shell", inline: <<-SHELL
      set -x
      echo "Updating package list..."
      sudo apt-get update
      echo "Installing curl..."
      sudo apt-get install -y curl
      echo "Waiting for node-token file..."
      while [ ! -f /vagrant/node-token ]; do sleep 1; done
      echo "node-token file found. Attempting to join the cluster..."
      K3S_TOKEN=$(cat /vagrant/node-token)
      echo "K3S_TOKEN: $K3S_TOKEN"
      while true; do
        curl -sfL https://get.k3s.io | K3S_URL=https://192.168.56.110:6443 K3S_TOKEN=$K3S_TOKEN sh -s - agent --node-ip 192.168.56.111 --node-name hbelleSW
        if [ $? -eq 0 ]; then
          echo "Successfully joined the cluster."
          break
        else
          echo "Failed to join the cluster. Retrying in 2 seconds..."
          sleep 2
        fi
      done
    SHELL
  end
end